<div class="competitor-app">
  @if (isCheckingPermission()) {
    <div class="loading-container">
      <div class="loading-spinner">
        <i class="pi pi-spin pi-spinner"></i>
      </div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else if (hasGeolocationPermission() === false) {
    <div class="permission-required">
      <div class="permission-card">
        <div class="permission-icon">
          <i class="pi pi-map-marker"></i>
        </div>
        <h2>{{ 'geolocation.title' | translate }}</h2>
        <p>{{ 'geolocation.message' | translate }}</p>
        <button class="permission-button" (click)="requestLocationPermission()">
          <i class="pi pi-map-marker"></i>
          <span>{{ 'geolocation.allowButton' | translate }}</span>
        </button>
      </div>
    </div>
  } @else {
    <app-competitor-header
      [startNumber]="currentUser?.startnumber ? '#' + currentUser?.startnumber : '#000'"
      [riderName]="getParticipantName()"
      [locationStatus]="getLocationStatus()"
      (logout)="logout()">
    </app-competitor-header>

    <div class="track-info-section">
      <div class="track-info">
        @if (trackInfo(); as track) {
          <div class="track-header">
            <div class="track-icon">
              <i class="pi pi-flag"></i>
            </div>
            <div class="track-content">
              <h2 class="track-title">{{ track.title }}</h2>
              <div class="track-details">
                <div class="track-detail-item">
                  <i class="pi pi-map-marker"></i>
                  <span class="track-distance">{{ track.distance }}</span>
                </div>
              </div>
            </div>
          </div>
        } @else {
          <div class="track-header">
            <div class="track-icon loading">
              <i class="pi pi-spin pi-spinner"></i>
            </div>
            <div class="track-content">
              <h2 class="track-title">Loading track information...</h2>
              <div class="track-details">
                <div class="track-detail-item">
                  <i class="pi pi-map-marker"></i>
                  <span class="track-distance">-- km</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <main class="competitor-main">
      @if (isAbandoned()) {
        <div class="abandoned-banner">
          <div class="abandoned-content">
            <i class="pi pi-exclamation-triangle"></i>
            <div class="abandoned-text">
            <h3>{{ 'competitor.abandonBrevet' | translate }}</h3>
            <p>{{ 'message.brevetAbandoned' | translate }}</p>
            </div>
          </div>
        </div>
      }

      <div class="checkpoints-section">
        <h2 class="section-title">{{ 'competitor.checkpoints' | translate }}</h2>
        <div class="checkpoints-grid">
          @if (checkpoints().length > 0) {
            @for (checkpoint of checkpoints(); track checkpoint.checkpoint_uid; let i = $index) {
              <app-checkpoint-card
                [checkpoint]="checkpoint"
                [trackUid]="currentUser?.trackuid || ''"
                [participantUid]="currentUser?.id || ''"
                [startNumber]="currentUser?.startnumber || ''"
                [isFirst]="i === 0"
                [isLast]="i === checkpoints().length - 1"
                [totalCheckpoints]="checkpoints().length"
                [disabled]="isAbandoned()"
                (actionCompleted)="onCheckpointActionCompleted($event)"
              ></app-checkpoint-card>
            }
          } @else {
            <div class="no-checkpoints">
              <div class="no-checkpoints-content">
                <i class="pi pi-info-circle"></i>
                <h3>{{ 'message.checkpointsComingSoon' | translate }}</h3>
                <p>{{ 'message.checkpointsComingSoon' | translate }}</p>
              </div>
            </div>
          }
        </div>
        @if (checkpoints().length > 0) {
          <div class="abandon-section">
            <button
              class="abandon-button"
              [class.undo-abandon]="isAbandoned()"
              (click)="abandonBrevet()">
              <i [class]="isAbandoned() ? 'pi pi-undo' : 'pi pi-times'"></i>
              <span>{{ isAbandoned() ? ('competitor.undoAbandon' | translate) : ('competitor.abandonBrevet' | translate) }}</span>
            </button>
          </div>
        }
      </div>
    </main>
  }
</div>
