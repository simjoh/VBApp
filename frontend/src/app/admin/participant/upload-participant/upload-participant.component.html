<div class="admin-card">
  <div class="card-header">
    <h3>
      {{ 'upload.uploadParticipants' | translate }}
      <span
        class="pi pi-info-circle ml-2"
        (click)="op.toggle($event)"
        style="font-size: 1.2em; cursor: pointer; color: #1976d2;"
        tabindex="0"
      ></span>
    </h3>
    <p>{{ 'upload.uploadParticipantsDescription' | translate }}</p>
  </div>
  <div class="card-content">

<p-overlayPanel #op>
  <div class="p-3">
    <h5 class="mb-3">{{ 'upload.csvFormatForParticipants' | translate }}</h5>
    <p class="mb-2"><strong>{{ 'upload.sixteenColumnsSeparatedBySemicolon' | translate }}</strong></p>
    <ol class="mb-3" style="padding-left: 1.5rem;">
      <li>{{ 'upload.startNumber' | translate }}</li>
      <li>{{ 'upload.firstName' | translate }}</li>
      <li>{{ 'upload.lastName' | translate }}</li>
      <li>{{ 'upload.gender' | translate }}</li>
      <li>{{ 'upload.clubName' | translate }}</li>
      <li>{{ 'upload.address' | translate }}</li>
      <li>{{ 'upload.postalCode' | translate }}</li>
      <li>{{ 'upload.city' | translate }}</li>
      <li>{{ 'upload.country' | translate }}</li>
      <li>{{ 'upload.email' | translate }}</li>
      <li>{{ 'upload.phone' | translate }}</li>
      <li>{{ 'upload.registrationDate' | translate }}</li>
      <li>{{ 'upload.birthYear' | translate }}</li>
      <li>{{ 'upload.referenceNumber' | translate }}</li>
      <li>{{ 'upload.physicalBrevetCard' | translate }}</li>
      <li>{{ 'upload.additionalInformation' | translate }}</li>
    </ol>
    <p class="mb-2"><strong>{{ 'upload.example' | translate }}</strong></p>
    <code class="text-sm" style="background: #f5f5f5; padding: 0.5rem; display: block; border-radius: 4px;">
      2002;Anna;Lindberg;Kvinna;Stockholm CK;Sveavägen 12;11157;Stockholm;Sverige;anna.lindberg&#64;example.se;0701234567;2023-05-12 14:22:00;1985;223344;Ja;Föredrar fysiskt brevetkort
    </code>
  </div>
</p-overlayPanel>
<div class="lg:col-5 md:col-12 sm:col-12">
  <brevet-tracks-for-event-selector [styleClass]="'lg:w-25 sm:w-full md:w-full'" (trackChange)="updateTtrack($event)"></brevet-tracks-for-event-selector>
</div>

<!-- Track Status Indicator -->
<div *ngIf="trackuid && selectedTrack" class="mt-2 col-12">
  <div class="flex align-items-center">
    <p-tag
      [severity]="selectedTrack.active ? 'success' : 'warning'"
      [value]="selectedTrack.active ? ('upload.trackActive' | translate) : ('upload.trackInactive' | translate)"
      [icon]="selectedTrack.active ? 'pi pi-check-circle' : 'pi pi-exclamation-triangle'">
    </p-tag>
    <span *ngIf="!selectedTrack.active" class="ml-2 text-sm text-orange-600">
      <i class="pi pi-info-circle"></i> {{ 'upload.uploadNotAllowedForInactiveTracks' | translate }}
    </span>
  </div>
</div>

<hr>

<div class="mt-3 col-12 lg:col-12 sm:col-12 ">
<p-fileUpload #primeFileUpload [disabled]="!trackuid" [fileLimit]="1" [accept]="'text/csv'"
  [chooseLabel]="'upload.chooseCsv' | translate"
  [uploadLabel]="'upload.uploadCsv' | translate"
  [showCancelButton]="false"
  name="myfile[]"
  [customUpload]="true" (onProgress)="progressReport($event)" (uploadHandler)="myUploader($event)">
  <ng-template let-file pTemplate='file'>
    <h4>{{ 'upload.selectedFiles' | translate }}</h4>
    <p-tag styleClass="">{{file.name}}  {{file.size}} bytes <button *ngIf="uploadedFiles.length === 0" class="pi pi-times p-button-sm p-button-icon-only" pButton type="button" label="Remove" (click)="removeFile(file, primeFileUpload)"></button></p-tag>
  </ng-template>
  <ng-template pTemplate="content">
    <ng-container *ngIf="uploadedFiles.length > 0">
    <h4 class="mt-2">{{ 'upload.uploadedFile' | translate }}</h4>
    <ng-container *ngFor="let file of uploadedFiles">
     <p-tag styleClass="mr-2" icon="pi pi-check" severity="success" value="{{file.name}} - {{file.size}} bytes"></p-tag>
    </ng-container>
    </ng-container>
  </ng-template>
</p-fileUpload>
</div>

<!-- Upload Statistics Display -->
<div *ngIf="showStats && uploadStats" class="mt-4 col-12">
  <div class="p-card" [ngClass]="'p-card--' + getSeverityClass()">
    <div class="p-card__header">
      <h3 class="p-card__title">
        <i class="pi" [ngClass]="{
          'pi-check-circle text-green-500': uploadStats.successful > 0 && uploadStats.failed === 0,
          'pi-exclamation-triangle text-orange-500': uploadStats.skipped > 0,
          'pi-times-circle text-red-500': uploadStats.failed > 0
        }"></i>
        {{ 'upload.uploadResult' | translate }}
        <button
          class="p-button p-button-text p-button-sm ml-auto"
          (click)="hideStats()"
          style="float: right;">
          <i class="pi pi-times"></i>
        </button>
      </h3>
    </div>

    <div class="p-card__body">
      <!-- Summary Statistics -->
      <div class="grid">
        <div class="col-12 md:col-3">
          <div class="text-center p-3 border-round bg-blue-50">
            <div class="text-2xl font-bold text-blue-600">{{uploadStats.total_rows}}</div>
            <div class="text-sm text-blue-700">{{ 'upload.totalRows' | translate }}</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="text-center p-3 border-round bg-green-50">
            <div class="text-2xl font-bold text-green-600">{{uploadStats.successful}}</div>
            <div class="text-sm text-green-700">{{ 'upload.successful' | translate }}</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="text-center p-3 border-round bg-orange-50">
            <div class="text-2xl font-bold text-orange-600">{{uploadStats.skipped}}</div>
            <div class="text-sm text-orange-700">{{ 'upload.skipped' | translate }}</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="text-center p-3 border-round bg-red-50">
            <div class="text-2xl font-bold text-red-600">{{uploadStats.failed}}</div>
            <div class="text-sm text-red-700">{{ 'upload.failed' | translate }}</div>
          </div>
        </div>
      </div>

      <!-- Error Details -->
      <div *ngIf="uploadStats.errors.length > 0" class="mt-4">
        <h4 class="mb-3">{{ 'upload.detailedErrors' | translate }}</h4>
        <div class="max-h-20rem overflow-y-auto">
          <div *ngFor="let error of uploadStats.errors" class="p-3 mb-2 border-round"
               [ngClass]="{
                 'bg-red-50 border-left-3 border-red-500': error.message.includes('Missing') || error.message.includes('Invalid'),
                 'bg-orange-50 border-left-3 border-orange-500': error.message.includes('already exists')
               }">
            <div class="font-semibold text-sm">
              {{ 'upload.row' | translate }} {{error.row}}: {{error.message}}
            </div>
            <div *ngIf="error.data" class="text-xs text-gray-600 mt-1">
              <strong>{{ 'upload.data' | translate }}:</strong> {{error.data.join('; ')}}
            </div>
          </div>
        </div>
      </div>

      <!-- Successfully Created Participants -->
      <div *ngIf="uploadStats.participants.length > 0" class="mt-4">
        <h4 class="mb-3">{{ 'upload.createdParticipants' | translate }}</h4>
        <div class="max-h-20rem overflow-y-auto">
          <div *ngFor="let participant of uploadStats.participants" class="p-3 mb-2 border-round bg-green-50">
            <div class="font-semibold">
              <span class="text-lg">{{participant.startnumber}}</span> -
              <span *ngIf="participant.competitor?.given_name && participant.competitor?.family_name">
                {{participant.competitor.given_name}} {{participant.competitor.family_name}}
              </span>
              <span *ngIf="!participant.competitor?.given_name || !participant.competitor?.family_name">
                {{ 'upload.participant' | translate }} ({{participant.competitor_uid}})
              </span>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              <span *ngIf="participant.use_physical_brevet_card" class="mr-3">
                <i class="pi pi-id-card text-blue-500"></i> {{ 'upload.physicalBrevetCard' | translate }}
              </span>
              <span *ngIf="participant.additional_information" class="mr-3">
                <i class="pi pi-info-circle text-orange-500"></i> {{participant.additional_information}}
              </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              ({{participant.participant_uid}})
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>

