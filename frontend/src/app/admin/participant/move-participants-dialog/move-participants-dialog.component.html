<div class="move-participants-dialog compact">
  <!-- Compact Header -->
  <div class="dialog-header mb-3">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-exchange text-primary" style="font-size: 1.2rem;"></i>
      <div>
        <h3 class="m-0 text-900">
          {{ dialogConfig.mode === 'single' ? 'Flytta Deltagare' : 'Flytta Deltagare' }}
        </h3>
        <p class="m-0 text-500 text-xs">
          {{ dialogConfig.mode === 'single' ? 'Välj målbana för deltagaren' : 'Välj käll- och målbana' }}
        </p>
      </div>
    </div>
  </div>

  <!-- Move Result Summary (Compact) -->
  <div *ngIf="$moveResult | async as result" class="mb-3">
    <div class="flex gap-2">
      <div class="flex-1 text-center p-2 border-round surface-border">
        <div class="text-green-500 font-bold">{{ result.success.length }}</div>
        <div class="text-500 text-xs">Framgångsrika</div>
      </div>
      <div class="flex-1 text-center p-2 border-round surface-border">
        <div class="text-orange-500 font-bold">{{ result.failed.length }}</div>
        <div class="text-500 text-xs">Misslyckade</div>
      </div>
      <div class="flex-1 text-center p-2 border-round surface-border">
        <div class="text-blue-500 font-bold">{{ result.skipped.length }}</div>
        <div class="text-500 text-xs">Hoppade över</div>
      </div>
    </div>
  </div>

  <!-- Main Form -->
  <form [formGroup]="moveForm" class="space-y-3">

    <!-- Compact Track Selection -->
    <div class="grid">
      <!-- From Track (Hidden in single mode) -->
      <div class="col-12" *ngIf="dialogConfig.mode === 'bulk'">
        <label class="block text-900 font-medium mb-1 text-sm">
          <i class="pi pi-map-marker mr-1"></i>Från Bana
        </label>
        <p-dropdown
          formControlName="fromTrackUid"
          [options]="$tracks | async"
          optionLabel="title"
          optionValue="track_uid"
          placeholder="Välj källbana"
          [showClear]="true"
          [filter]="true"
          filterPlaceholder="Sök..."
          styleClass="w-full p-inputtext-sm"
          (onChange)="onFromTrackChange($event.value)">
          <ng-template pTemplate="selectedItem" let-track>
            <div class="flex flex-column">
              <span class="text-sm">{{ track?.title }}</span>
              <small class="text-500">{{ track?.start_date_time | date:'yyyy-MM-dd' }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-track>
            <div class="flex flex-column">
              <span class="text-sm">{{ track.title }}</span>
              <small class="text-500">{{ track.start_date_time | date:'yyyy-MM-dd' }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="empty">
            <div class="p-1 text-xs">Inga banor tillgängliga</div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- To Track -->
      <div class="col-12">
        <label class="block text-900 font-medium mb-1 text-sm">
          <i class="pi pi-arrow-right mr-1"></i>Till Bana
        </label>
        <p-dropdown
          formControlName="toTrackUid"
          [options]="$tracks | async"
          optionLabel="title"
          optionValue="track_uid"
          placeholder="Välj målbana"
          [showClear]="true"
          [filter]="true"
          filterPlaceholder="Sök..."
          styleClass="w-full p-inputtext-sm"
          (onChange)="onToTrackChange($event.value)">
          <ng-template pTemplate="selectedItem" let-track>
            <div class="flex flex-column">
              <span class="text-sm">{{ track?.title }}</span>
              <small class="text-500">{{ track?.start_date_time | date:'yyyy-MM-dd' }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-track>
            <div class="flex flex-column">
              <span class="text-sm">{{ track.title }}</span>
              <small class="text-500">{{ track.start_date_time | date:'yyyy-MM-dd' }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="empty">
            <div class="p-1 text-xs">Inga banor tillgängliga</div>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <!-- Compact Track Info -->
    <div class="grid" *ngIf="($selectedFromTrack | async) && ($selectedToTrack | async)">
      <div class="col-12 md:col-6" *ngIf="dialogConfig.mode === 'bulk'">
        <div class="p-2 border-round surface-border text-xs">
          <div class="font-medium">Från: {{ ($selectedFromTrack | async)?.title }}</div>
          <div class="text-500">{{ ($participantsOnFromTrack | async)?.length || 0 }} deltagare</div>
        </div>
      </div>
      <div class="col-12" [class.md:col-6]="dialogConfig.mode === 'bulk'">
        <div class="p-2 border-round surface-border text-xs">
          <div class="font-medium">Till: {{ ($selectedToTrack | async)?.title }}</div>
          <div class="text-500">{{ ($selectedToTrack | async)?.start_date_time | date:'yyyy-MM-dd' }}</div>
        </div>
      </div>
    </div>

    <!-- Enhanced Participant Selection (Bulk Mode) -->
    <div *ngIf="dialogConfig.mode === 'bulk' && ($participantsOnFromTrack | async) as participants">
      <div class="flex justify-content-between align-items-center mb-2">
        <label class="block text-900 font-medium text-sm">
          <i class="pi pi-users mr-1"></i>Deltagare ({{ participants.length }})
        </label>
        <div class="flex align-items-center gap-2">
          <div class="text-500 text-xs">
            <span class="font-medium text-primary">{{ getMovableParticipantsCount(participants) }}</span> av <span class="font-medium">{{ participants.length }}</span> kan flyttas
          </div>
          <button
            *ngIf="($moveResult | async)?.failed?.length > 0"
            pButton
            pRipple
            type="button"
            class="p-button-outlined p-button-warning p-button-sm"
            icon="pi pi-wrench"
            label="Lös alla konflikter"
            [loading]="resolvingConflicts"
            (click)="resolveAllConflicts()">
          </button>
        </div>
      </div>

      <div class="border-round surface-border shadow-1" style="max-height: 350px; overflow-y: auto;">
        <p-table
          [value]="participants"
          styleClass="p-datatable-sm"
          [rowHover]="true">

          <ng-template pTemplate="header">
            <tr>
              <th style="width: 4rem" class="text-center">Nr</th>
              <th style="width: 35%">Namn</th>
              <th style="width: 25%">Klubb</th>
              <th style="width: 4rem" class="text-center">Status</th>
              <th style="width: 7rem" class="text-center" *ngIf="($moveResult | async)?.failed?.length > 0">Åtgärd</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-participant let-rowIndex="rowIndex">
            <tr [class.opacity-50]="!canMoveParticipant(participant)">
              <td class="text-center">
                <span class="font-medium text-sm">{{ participant.participant.startnumber }}</span>
              </td>
              <td>
                <div class="text-sm">
                  <div class="font-medium">{{ participant.competitorRepresentation.family_name }}</div>
                  <div class="text-500">{{ participant.competitorRepresentation.given_name }}</div>
                </div>
              </td>
              <td>
                <div class="text-500 text-xs">{{ participant.clubRepresentation.title }}</div>
              </td>
              <td class="text-center">
                <p-tag
                  [value]="getParticipantStatusText(participant)"
                  [severity]="getParticipantStatusSeverity(participant)"
                  styleClass="text-xs">
                </p-tag>
              </td>
              <td class="text-center" *ngIf="($moveResult | async)?.failed?.length > 0">
                <button
                  *ngIf="shouldShowResolveButtonForParticipant(participant.participant.participant_uid)"
                  pButton
                  pRipple
                  label="Lös"
                  icon="pi pi-wrench"
                  class="p-button-outlined p-button-warning p-button-sm"
                  [loading]="isResolving(participant.participant.participant_uid) || resolvingConflicts"
                  (click)="resolveFailed(participant.participant.participant_uid)">
                </button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center p-2">
                <div class="text-500 text-xs">Inga deltagare hittades</div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="mt-2">
        <div class="text-500 text-xs">
          <i class="pi pi-info-circle mr-1"></i>
          Endast deltagare som inte har startat kan flyttas
        </div>
      </div>
    </div>

    <!-- Compact Single Participant Info -->
    <div *ngIf="dialogConfig.mode === 'single' && dialogConfig.participant as participant" class="mb-3">
      <div class="p-3 border-round surface-border">
        <div class="flex align-items-center gap-3">
          <div class="text-center">
            <div class="text-900 font-bold text-lg">{{ participant.participant.startnumber }}</div>
            <div class="text-500 text-xs">Startnummer</div>
          </div>
          <div class="flex-1">
            <div class="text-900 font-medium">{{ participant.competitorRepresentation.family_name }}, {{ participant.competitorRepresentation.given_name }}</div>
            <div class="text-500 text-xs">{{ participant.clubRepresentation.title }}</div>
          </div>
          <div>
            <p-tag
              [value]="getParticipantStatusText(participant)"
              [severity]="getParticipantStatusSeverity(participant)">
            </p-tag>
          </div>
          <div class="ml-1">
            <button
              *ngIf="$moveResult | async as result; else noConflict"
              pButton
              pRipple
              type="button"
              label="Lös"
              icon="pi pi-wrench"
              class="p-button-outlined p-button-warning p-button-sm"
              [loading]="resolvingConflicts"
              (click)="resolveConflict(participant.participant.participant_uid, moveForm.get('toTrackUid')?.value)"
              [style.display]="(result?.failed?.length || 0) > 0 ? 'inline-flex' : 'none'">
            </button>
            <ng-template #noConflict></ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Compact Conflict Resolution -->
    <div *ngIf="$moveResult | async as result" class="space-y-2">
      <!-- Failed Participants (summary only) -->
      <div *ngIf="result.failed.length > 0">
        <h5 class="text-orange-600 mb-1 text-sm">
          <i class="pi pi-exclamation-triangle mr-1"></i>Misslyckade ({{ result.failed.length }})
        </h5>
        <div class="text-500 text-xs">Konflikter kan lösas via knappar i tabellen ovan eller "Lös alla konflikter" ovanför tabellen.</div>
      </div>

      <!-- Skipped Participants -->
      <div *ngIf="result.skipped.length > 0">
        <h5 class="text-blue-600 mb-1 text-sm">
          <i class="pi pi-info-circle mr-1"></i>Hoppade över ({{ result.skipped.length }})
        </h5>
        <div class="space-y-1">
          <div *ngFor="let skipped of result.skipped" class="p-2 border-round surface-border text-xs">
            <div class="font-medium text-blue-600">#{{ skipped.participant_uid }}</div>
            <div class="text-500">{{ skipped.reason }}</div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Compact Action Buttons -->
      <div class="flex justify-content-end gap-2 mt-3 pt-3 border-top-1 surface-border">
    <button
      pButton
      pRipple
      label="Avbryt"
      icon="pi pi-times"
      class="p-button-outlined p-button-secondary p-button-sm"
      (click)="close()">
    </button>

    <button
      pButton
      pRipple
      label="{{ dialogConfig.mode === 'single' ? 'Flytta' : 'Flytta Alla Deltagare' }}"
      icon="pi pi-exchange"
      class="p-button-success p-button-sm"
      [disabled]="loading || !($canMove | async)"
      [loading]="loading"
      (click)="moveParticipants()">
    </button>

    <button
      *ngIf="$moveResult | async"
      pButton
      pRipple
      label="Stäng"
      icon="pi pi-check"
      class="p-button-primary p-button-sm"
      (click)="confirmAndClose()">
    </button>
  </div>
</div>
