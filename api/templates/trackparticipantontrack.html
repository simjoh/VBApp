<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Route details for: {{competitor.given_name }} {{competitor.family_name }}</title>

	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.bunny.net">
	<link href="https://fonts.bunny.net/css?family=figtree:400,600&display=swap" rel="stylesheet"/>

	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans">

<div class="container mx-auto px-4 py-8">
	<div class="mb-5 text-left">
		<p class="mt-5 mb-1 font-extrabold text-2xl">{{track.title}}</p>
		<p class="mb-1">Brevet card for: {{competitor.givenname}} {{competitor.familyname }}</p>
	</div>

	<div class="overflow-x-auto">
		<table class="min-w-full text-left text-md font-light">
			<thead>
			<tr class="bg-gray-700 border-b-1 border-black">
				<th class="py-2 px-2 text-white">Control</th>
				<th class="py-2 px-2 text-white">Km</th>
				<th class="py-2 px-2 text-white">Km Total</th>
				<th class="py-2 px-1 text-white sm:max-w-xs md:max-w-sm lg:max-w-md xl:max-w-lg">Check-in</th>
				<th class="py-2 px-1 text-white">Avg. km/h</th>
				<th class="py-2 px-1 text-white">Time</th>
				<th class="py-2 px-1 text-white">Time Total</th>
				<th class="py-2 px-1 text-white">Status</th>
			</tr>
			</thead>
			<tbody>

			{% set show = true %}

			{% for entry in trackinginfo %}

			{% if loop.first %}
				{% set first_time = entry.passeded_date_time %}
				{% set prev_time = entry.passeded_date_time %}
				{% set prev_dist = entry.distance %}
			{% endif %}

			{% set delta_dist = entry.distance - prev_dist %}
			{% set delta_time = date(prev_time).diff(date(entry.passeded_date_time)) %}
			{% if delta_dist > 0 %}
				{% if delta_time.a * 24 + delta_time.h + delta_dist.i/60 != 0 %}
					{% set speed = delta_dist / (delta_time.a * 24 + delta_time.h + delta_dist.i/60) %}
				{% else %}
					{% set speed = null %} {# or you can assign a different value based on your requirements #}
				{% endif %}
			{% endif %}

			{% set prev_dist = entry.distance %}
			{% set prev_time = entry.passeded_date_time %}
			{% set total_time = date(first_time).diff(date(entry.passeded_date_time)) %}

			{% if show %}

			<tr class="{{ loop.index % 2 == 0 ? 'bg-white' : 'bg-gray-200' }} border-b dark:border-neutral-500 dark:bg-neutral-700">
				<td class="py-2 px-1">{{ entry.place }}</td>
				<td class="py-2 px-1">{{ delta_dist }}</td>
				<td class="py-2 px-1">{{ entry.distance }}</td>
				<td class="py-2 px-1 sm:max-w-xs md:max-w-sm lg:max-w-md xl:max-w-lg truncate">
					{{ entry.passeded_date_time | date('D j M H:i') }} <!-- https://www.php.net/manual/en/datetime.format.php -->
				</td>
				<td class="py-2 px-1">{{ speed }}</td>
				<td class="py-2 px-1">{{ delta_time | date('%a:%H:%I') }}</td> <!-- https://www.php.net/DateInterval.format -->
				<td class="py-2 px-1">{{ total_time | date('%a:%H:%I') }}</td> <!-- https://www.php.net/DateInterval.format -->
				<td class="py-2 px-1">
					{% if entry.passeded_date_time is not null %}
						{% if loop.last and entry.finished %}
							FIN
						{% else %}
							CHECKED IN
						{% endif %}
					{% else %}
						{% if entry.dns %}
							DNS
							{% set show = false %} <!-- hide remaining rows -->
						{% elseif entry.dnf %}
							DNF
							{% set show = false %} <!-- hide remaining rows -->
						{% else %}
							<!-- no status -->
						{% endif %} 
					{% endif %}
				</td>
			</tr>

			{% endif %} 
				
			{% if entry.finished and loop.last %}
			<tr class="bg-gray-200 border-t border-black dark:border-neutral-500 dark:bg-neutral-700 even:bg-white">
				<td colspan="7" class="py-2 px-2 text-right"></td>
				<td class="py-2 px-1">Time: {{ entry.time }}</td>
			</tr>
			{% endif %}
				
			{% endfor %}
				
			</tbody>
		</table>
	</div>
</div>

</body>
</html>
